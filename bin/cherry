#! /bin/bash -e

set -o pipefail

# List all commits with git-cherry and exclude all the ones that are already
# part of the change log of the current branch.  For each available commit,
# invoke 'git show' to print the commit message.

export PAGER=""

block_file=$(git rev-parse --show-cdup).gitcherryblock

if ! test -f $block_file ; then
    touch $block_file
fi

tempfile=$(tempfile -p $(basename $0))
git log --pretty=format:%b $1 | sed -ne 's/^commit \([a-z0-9]\{40\}\)$/\1/p' > $tempfile

for commit in $(git cherry $* | sed -ne 's/^+ //p' | grep -v -f $tempfile -f $block_file) ; do
    git show -s --pretty=format:"%H %s%n" $commit
done

rm -f $tempfile
